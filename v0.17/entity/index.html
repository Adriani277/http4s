<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <title>http4s: Entity handling</title>

  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.17/css/bootstrap.min.css" >  
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.17/css/font-awesome.min.css" >  
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.17/css/fontello.css" >
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Share+Tech+Mono" >
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.17/css/highlight-github.css">
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.17/css/style.css" >
</head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
	<img src="https://http4s.org/v0.17/images/http4s-logo.svg" alt="logo" class="logo" /> http4s
      </a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
	
	
	<li class="dropdown">
  <a class="dropdown-toggle" id="doc-menu-item" data-toggle="dropdown" data-target="#" href="https://http4s.org/" role="button" aria-haspopup="true" aria-expanded="false">
    Documentation <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" aria-labelledby="doc-menu-item">
    <li><a href="/versions/">Versions</a></li>
    
    <li role="separator" class="divider"></li>
    <li class="dropdown-header">v0.17 (development)</li>
    <li><a href="/v0.17/">Tutorial</a></li>
    <li><a href="/v0.17/api/org/http4s/">Scaladoc</a></li>
    
    <li role="separator" class="divider"></li>
    <li class="dropdown-header">v0.16 (development)</li>
    <li><a href="/v0.16/">Tutorial</a></li>
    <li><a href="/v0.16/api/org/http4s/">Scaladoc</a></li>
    
    <li role="separator" class="divider"></li>
    <li class="dropdown-header">v0.15</li>
    <li><a href="/v0.15/">Tutorial</a></li>
    <li><a href="/v0.15/api/org/http4s">Scaladoc</a></li>
  </ul>
</li>

      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/http4s/http4s" title="http4s/http4s on GitHub"><span class="icon-github-circled"></span></a></li>	
        <li><a href="https://gitter.im/http4s/http4s" title="http4s/http4s on Gitter"><span class="icon-gitter" aria-hidden="true"></span></a></li>
        <li><a href="https://twitter.com/http4s" title="@http4s on Twitter"><span class="icon-twitter" aria-hidden="true"></span></a></li>
      </ul>
    </div>
  </div>
</nav>

    <div class="container">
      <div class="content">
        <div class="col-md-10" role="main">
          <div class="page-header">
            <h1>Entity handling</h1>
          </div>
          

<h2 id="why-entity">Why Entity*</h2>

<p>Http4s handles HTTP requests and responses in a streaming fashion. Your service
will receive a request after the header has been parsed (ok, not 100%
streaming), but before the body has been fully received. The same applies to the
http client usage, where you can start a connection before the body is fully
materialized. You don&rsquo;t have to load the full body into memory to submit the
request either. Taking a look at <code>Request</code> and <code>Response</code>, both have a body of
type <code>EntityBody</code>, which is simply an alias to <code>Stream[Task, ByteVector]</code>. To
understand <code>Stream</code>, take a look at the <a href="https://gist.github.com/djspiewak/d93a9c4983f63721c41c">streams-tutorial</a>.</p>

<p>The <code>EntityDecoder</code> and <code>EntityEncoder</code> help with the streaming nature of the
data in a http body, and they also have additional logic to deal with media
types. Not all decoders are streaming, depending on the implementation.</p>

<h2 id="construction-and-media-types">Construction and Media Types</h2>

<p><code>Entity*</code>s also encode which media types they correspond to. The
<code>EntityDecoder</code>s for json expect <code>application/json</code>. To implement this
functionality, the constructor <code>EntityDecoder.decodeBy</code> uses <code>MediaRange</code>s. You
can pass multiple as needed. You can also append functionality to an existing
one via <code>EntityDecoder[T].map</code> - however, you can&rsquo;t change the media
type in that case.</p>

<p>When you encode a body with the <code>EntityEncoder</code> for json, it appends the
<code>Content-Type: application/json</code> header. You can construct new encoders via
<code>EntityEncoder.encodeBy</code> or reuse an already existing one via
<code>EntityEncoder[T].contramap</code> and <code>withContentType</code>.</p>

<p>See the <a href="../api/org/http4s/MediaRange$">MediaRange</a> companion object for ranges, and <a href="../api/org/http4s/MediaType$">MediaType</a> for specific
types. Because of the implicit conversions, you can also use <code>(String, String)</code>
for a <code>MediaType</code>.</p>

<p>By default, decoders content types are ignored since it could lead to unexpected
runtime errors.</p>

<h2 id="chaining-decoders">Chaining Decoders</h2>

<p>Decoders&rsquo; content types are used when chaining decoders with <code>orElse</code> in order to
determine which of the chained decoders are to be used.</p>

<pre><code class="language-scala">scala&gt; import org.http4s._
import org.http4s._

scala&gt; import org.http4s.dsl._
import org.http4s.dsl._

scala&gt; import cats._
import cats._

scala&gt; import cats.implicits._
import cats.implicits._

scala&gt; import cats.data._
import cats.data._

scala&gt; sealed trait Resp
defined trait Resp

scala&gt; case class Audio(body: String) extends Resp
defined class Audio

scala&gt; case class Video(body: String) extends Resp
defined class Video

scala&gt; val response = Ok().withBody(&quot;&quot;).withContentType(Some(MediaType.`audio/ogg`))
response: fs2.Task[org.http4s.Response] = Task

scala&gt; val audioDec = EntityDecoder.decodeBy(MediaType.`audio/ogg`) { msg =&gt;
     |   EitherT {
     |     msg.as[String].map(s =&gt; Audio(s).asRight[DecodeFailure])
     |   }
     | }
audioDec: org.http4s.EntityDecoder[Audio] = org.http4s.EntityDecoder$$anon$3@6ca0214c

scala&gt; val videoDec = EntityDecoder.decodeBy(MediaType.`video/ogg`) { msg =&gt;
     |   EitherT {
     |     msg.as[String].map(s =&gt; Video(s).asRight[DecodeFailure])
     |   }
     | }
videoDec: org.http4s.EntityDecoder[Video] = org.http4s.EntityDecoder$$anon$3@1a650845

scala&gt; val bothDec = audioDec.widen[Resp] orElse videoDec.widen[Resp]
bothDec: org.http4s.EntityDecoder[Resp] = org.http4s.EntityDecoder$OrDec@2e27f779

scala&gt; println(response.as(bothDec).unsafeRun)
Audio()
</code></pre>

<h2 id="presupplied-encoders-decoders">Presupplied Encoders/Decoders</h2>

<p>The <code>EntityEncoder</code>/<code>EntityDecoder</code>s shipped with http4s.</p>

<h3 id="raw-data-types">Raw Data Types</h3>

<p>These are already in implicit scope by default, e.g. <code>String</code>, <code>File</code>,
<code>Future[_]</code>, and <code>InputStream</code>. Consult <a href="../api/org/http4s/EntityEncoder$">EntityEncoder</a> and <a href="../api/org/http4s/EntityDecoder$">EntityDecoder</a> for
a full list.</p>

<h3 id="json">JSON</h3>

<p>With <code>jsonOf</code> for the <code>EntityDecoder</code>, and <code>jsonEncoderOf</code> for the <code>EntityEncoder</code>:</p>

<ul>
<li>argonaut: <code>&quot;org.http4s&quot; %% &quot;http4s-argonaut&quot; % Http4sVersion</code></li>
<li>circe: <code>&quot;org.http4s&quot; %% &quot;http4s-circe&quot; % Http4sVersion</code></li>
<li>json4s-native: <code>&quot;org.http4s&quot; %% &quot;http4s-json4s-native&quot; % Http4sVersion</code></li>
<li>json4s-jackson: <code>&quot;org.http4s&quot; %% &quot;http4s-json4s-jackson&quot; % Http4sVersion</code></li>
</ul>

<h3 id="xml">XML</h3>

<p>For scala-xml (xml literals), import <code>org.http4s.scalaxml</code>. No direct naming
required here, because there is no Decoder instance for <code>String</code> that would
cause conflicts with the builtin Decoders.</p>

<ul>
<li>scala-xml: <code>&quot;org.http4s&quot; %% &quot;http4s-scala-xml&quot; % Http4sVersion</code></li>
</ul>

<h3 id="twirl">Twirl</h3>

<p>If you&rsquo;re working with <a href="https://github.com/playframework/twirl">twirl</a> templates, there&rsquo;s a bridge for that too:</p>

<ul>
<li>scala-twirl: <code>&quot;org.http4s&quot; %% &quot;http4s-twirl&quot; % Http4sVersion</code></li>
</ul>

          <footer>
            <nav>
              <ul class="pager">
                
                <li>
<a href="https://github.com/http4s/http4s/edit/release-0.17.x/docs/src/main/tut/entity.md"><i class="fa fa-pencil"></i> Edit this page</a>
</li>
                
              </ul>
            </nav>
          </footer>
        </div>
        <div class="col-md-2" role="complementary">
          <nav class="tut-nav" data-spy="affix" data-offset-top="60" data-offset-bottom="200">
            <ul class="nav">
              
              
              <li >
                <a href="/v0.17/">Quick Start</a>
              </li>
              
              <li >
                <a href="/v0.17/service/">Service</a>
              </li>
              
              <li >
                <a href="/v0.17/dsl/">The http4s DSL</a>
              </li>
              
              <li >
                <a href="/v0.17/middleware/">Middleware</a>
              </li>
              
              <li >
                <a href="/v0.17/auth/">Authentication</a>
              </li>
              
              <li >
                <a href="/v0.17/cors/">CORS</a>
              </li>
              
              <li >
                <a href="/v0.17/gzip/">GZip Compression</a>
              </li>
              
              <li >
                <a href="/v0.17/hsts/">HSTS</a>
              </li>
              
              <li >
                <a href="/v0.17/static/">Static Files</a>
              </li>
              
              <li >
                <a href="/v0.17/client/">HTTP Client</a>
              </li>
              
              <li class="active">
                <a href="/v0.17/entity/">Entity handling</a>
              </li>
              
              <li >
                <a href="/v0.17/streaming/">Streaming</a>
              </li>
              
              <li >
                <a href="/v0.17/json/">JSON handling</a>
              </li>
              
              <li >
                <a href="/v0.17/uri/">URI handling</a>
              </li>
              
              <li >
                <a href="/v0.17/api">Scaladoc</a>
              </li>
              
            </ul>
          </nav>
        </div>
      </div>
    </div>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<script src="https://http4s.org/v0.17/js/bootstrap.min.js"></script>    
<script src="https://http4s.org/v0.17/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

  </body>
</html>
